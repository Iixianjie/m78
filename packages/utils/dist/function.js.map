{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/utils/src/function.ts"],"sourcesContent":["/**\n * 将一个错误优先且回调位于最后一个参数的node风格的callback函数转为Promise return函数\n * @param fn - 要包装的函数\n * @param {object} receiver - 要绑定作用域的对象\n * @return promise - 转换后的函数\n */\nimport { AnyFunction, EmptyFunction } from \"./types\";\n\nexport function promisify<T = any>(\n  fn: AnyFunction,\n  receiver?: object\n): (...args: Parameters<AnyFunction>) => Promise<T> {\n  return (...args) => {\n    return new Promise<T>((resolve, reject) => {\n      fn.apply(receiver, [\n        ...args,\n        (err, res) => {\n          return err ? reject(err) : resolve(res);\n        },\n      ]);\n    });\n  };\n}\n\n/**\n * 返回一个延迟指定时间的Promise\n * @param ms - 延迟时间\n * @param payload - 将要resolve的任意值，如果是Error对象，则promise会抛出异常\n * @return - Promise\n * */\nexport function delay<T = any>(\n  ms: number,\n  payload?: T\n): Promise<T extends Error ? void : T> {\n  return new Promise((res, rej) => {\n    setTimeout(\n      () => (payload instanceof Error ? rej(payload) : res(payload as any)),\n      ms\n    );\n  });\n}\n\n/** 接收任意参数并返回, 用例是作为一个无效接收器或默认参数使用 */\nexport const dumpFn = (...arg: any[]): any => arg;\n\n/** 延迟执行一个函数 */\nexport const defer = (fn: AnyFunction, ...args: any[]): any =>\n  setTimeout(fn, 1, ...args);\n\nconst defaultConfig = {\n  rate: 0.2,\n};\n\n/** retry函数的配置 */\nexport interface FunctionReTryConfig {\n  maxDelay?: number;\n  rate?: number;\n  fixed?: boolean;\n  maxRetry?: number;\n}\n\n/**\n * 执行一次handle，如果handle\n * @param handle - 处理函数，调用retry时会立即执行一次，如果handle执行返回了truthy值，则会在下一延迟执行点重新执行handle\n * @param delay - 进行重试间隔的毫秒，默认情况下，每次执行的间隔会通过边际递增算法增加, 可以通过config.fixed取消此行为\n * @param config - 配置\n * @param config.maxDelay - 重试延迟的最大延迟\n * @param config.rate - 0.2 | 递增比，此比例越大，则重试的频率越小\n * @param config.fixed - 不使用边际递增算法，固定重试时间\n * @param config.maxRetry - 最大重复次数\n * @return clear() - 用于停止重试并清理内部计时器\n * */\nexport function retry(\n  handle: () => any,\n  delay: number,\n  config?: FunctionReTryConfig\n): EmptyFunction {\n  const { maxDelay, rate, fixed, maxRetry } = { ...defaultConfig, ...config };\n\n  let t;\n  const clear = () => t && clearTimeout(t);\n\n  const res = handle();\n  if (!res) return clear;\n\n  let d = delay;\n  let count = 1;\n\n  const trigger = () => {\n    t = setTimeout(() => {\n      if (handle()) {\n        if (maxRetry && maxRetry === count) return;\n        if (!fixed) {\n          const nextD = count * rate * delay + d;\n          d = maxDelay ? Math.min(nextD, maxDelay) : nextD;\n        }\n        count++;\n        trigger();\n      }\n    }, d);\n  };\n\n  trigger();\n\n  return clear;\n}\n\n// TODO: 增加异步版本 asyncRetry\n"],"names":["promisify","fn","receiver","args","Promise","resolve","reject","apply","err","res","delay","ms","payload","rej","setTimeout","Error","dumpFn","arg","defer","defaultConfig","rate","retry","handle","config","maxDelay","fixed","maxRetry","t","clear","clearTimeout","d","count","trigger","nextD","Math","min"],"mappings":"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"}