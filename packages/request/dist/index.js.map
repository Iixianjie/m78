{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/request/src/index.ts"],"sourcesContent":["import _defaultsDeep from \"lodash/defaultsDeep\";\nimport { AnyObject } from \"@lxjx/utils\";\nimport { BaseRequestOptions, CreateOptions, Request } from \"./interfaces\";\nimport { defaultCreateConfig } from \"./default\";\nimport { CorePlugin } from \"./core-plugin\";\nimport { ResponseError } from \"./response-error\";\nimport { isFunction, isTruthyOrZero } from \"@m78/utils\";\n\n/**\n * 创建Request实例\n * <Opt> - 创建的request函数的配置参数类型\n * @param options - 配置\n * @return - Request实例\n * */\nexport const createRequest = <Opt extends BaseRequestOptions>(\n  options: CreateOptions<Opt>\n) => {\n  // 创建时配置\n  const cOpt = {\n    ...defaultCreateConfig,\n    ...options,\n    plugins: [CorePlugin, ...(options.plugins || [])],\n  } as CreateOptions<Opt>;\n\n  const { baseOptions } = cOpt;\n\n  const request: Request<Opt> = async (url, optionsArg) => {\n    // 请求时配置\n    const options: Opt = _defaultsDeep(\n      {\n        url,\n        extraOption: {},\n      },\n      optionsArg,\n      baseOptions,\n      {\n        headers: {\n          \"Content-Type\": \"application/json;charset=UTF-8\",\n        },\n      }\n    );\n\n    // 额外配置\n    const extra: Opt[\"extraOption\"] = options.extraOption!;\n\n    const ctx: AnyObject = {};\n\n    const format = extra!.format || cOpt.format;\n\n    const plugins = cOpt.plugins!.map((Plugin) => {\n      return new Plugin(ctx, cOpt, options);\n    });\n\n    /* ======== before ======= */\n    for (const plugin of plugins) {\n      const returns = plugin.before?.();\n\n      if (isTruthyOrZero(returns)) {\n        return returns;\n      }\n    }\n\n    return (\n      cOpt.adapter!(options)\n        /* ======== pipe ======= */\n        .then((response) => {\n          return plugins.reduce((prev, plugin) => {\n            if (isFunction(plugin.pipe)) {\n              return plugin.pipe(prev);\n            }\n            return prev;\n          }, response);\n        })\n        /* ======== success ======= */\n        .then((response) => {\n          let res = response;\n\n          // 格式化返回\n          if (format && !extra.plain) {\n            res = format(response, options);\n          }\n\n          plugins.forEach((plugin) => {\n            plugin.success?.(res, response);\n          });\n\n          return res;\n        })\n        /* ======== error ======= */\n        .catch((error: ResponseError) => {\n          plugins.forEach((plugin) => {\n            plugin.error?.(error);\n          });\n\n          return Promise.reject(error);\n        })\n        /* ======== finish ======= */\n        .finally(() => {\n          plugins.forEach((plugin) => {\n            plugin.finish?.();\n          });\n        })\n    );\n  };\n\n  return request;\n};\n\nexport * from \"./plugin\";\n"],"names":["_defaultsDeep","defaultCreateConfig","CorePlugin","isFunction","isTruthyOrZero","createRequest","options","cOpt","plugins","baseOptions","request","url","optionsArg","extra","ctx","format","plugin","returns","extraOption","headers","map","Plugin","before","adapter","then","response","reduce","prev","pipe","res","plain","forEach","success","catch","error","Promise","reject","finally","finish"],"mappings":"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"}