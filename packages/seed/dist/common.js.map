{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/seed/src/common.ts"],"sourcesContent":["import { AnyObject } from '@lxjx/utils';\nimport {\n  Seed,\n  CreateSeedConfig,\n  Listener,\n  MiddlewareBonusInit,\n  MiddlewareBonusPatch,\n  Share,\n  Subscribe,\n} from './types';\n\n/**\n * 生成和实现subscribe() api\n * - 通知功能在setDeps内部\n * */\nexport function subscribeImpl(share: Share): Subscribe {\n  return (listener: Listener) => {\n    share.listeners.push(listener);\n\n    return () => {\n      const ind = share.listeners.indexOf(listener);\n      if (ind === -1) return;\n      share.listeners.splice(ind, 1);\n    };\n  };\n}\n\n/**\n * 实现中间件功能\n * */\nexport function middlewareImpl(conf: CreateSeedConfig) {\n  const { middleware } = conf;\n\n  if (!middleware?.length) return [conf] as const;\n\n  const allMid = [...middleware];\n\n  const ctx: AnyObject = {};\n\n  const initBonus: MiddlewareBonusInit = {\n    ctx,\n    config: conf,\n    init: true,\n  };\n\n  allMid.forEach(mid => {\n    if (mid) {\n      const nextConf = mid(initBonus);\n      if (nextConf === undefined)\n        throw Error(\n          'seed: do you forget to return to the config during the middleware initialization phase?',\n        );\n      initBonus.config = nextConf;\n    }\n  });\n\n  const patchHandler = (apis: Seed) => {\n    const patchBonus: MiddlewareBonusPatch = {\n      init: false,\n      apis,\n      ctx,\n      monkey: (name, cb) => {\n        const next = apis[name];\n        if (!next) return;\n        apis[name] = cb(next);\n      },\n    };\n\n    allMid.reverse(); /* patch函数是由内到外执行的，需要反转顺序 */\n\n    allMid.forEach(mid => mid && mid(patchBonus));\n  };\n\n  return [initBonus.config, patchHandler] as const;\n}\n"],"names":["subscribeImpl","share","listener","listeners","push","ind","indexOf","splice","middlewareImpl","conf","middleware","length","allMid","ctx","initBonus","config","init","forEach","mid","nextConf","undefined","Error","patchHandler","apis","patchBonus","monkey","name","cb","next","reverse"],"mappings":"AAAA;AAWA;;;GAGG,GACH,OAAO,SAASA,aAAa,CAACC,KAAY,EAAa;IACrD,OAAO,SAACC,QAAkB,EAAK;QAC7BD,KAAK,CAACE,SAAS,CAACC,IAAI,CAACF,QAAQ,CAAC,CAAC;QAE/B,OAAO,WAAM;YACX,IAAMG,GAAG,GAAGJ,KAAK,CAACE,SAAS,CAACG,OAAO,CAACJ,QAAQ,CAAC,AAAC;YAC9C,IAAIG,GAAG,KAAK,CAAC,CAAC,EAAE,OAAO;YACvBJ,KAAK,CAACE,SAAS,CAACI,MAAM,CAACF,GAAG,EAAE,CAAC,CAAC,CAAC;QACjC,CAAC,CAAC;IACJ,CAAC,CAAC;AACJ,CAAC;AAED;;GAEG,GACH,OAAO,SAASG,cAAc,CAACC,IAAsB,EAAE;IACrD,IAAM,AAAEC,UAAU,GAAKD,IAAI,CAAnBC,UAAU,AAAS,AAAC;IAE5B,IAAI,CAACA,CAAAA,UAAU,aAAVA,UAAU,WAAQ,GAAlBA,KAAAA,CAAkB,GAAlBA,UAAU,CAAEC,MAAM,CAAA,EAAE,OAAO;QAACF,IAAI;KAAC,CAAU;IAEhD,IAAMG,MAAM,GAAI,qBAAGF,UAAU,CAAVA,AAAW,AAAC;IAE/B,IAAMG,GAAG,GAAc,EAAE,AAAC;IAE1B,IAAMC,SAAS,GAAwB;QACrCD,GAAG,EAAHA,GAAG;QACHE,MAAM,EAAEN,IAAI;QACZO,IAAI,EAAE,IAAI;KACX,AAAC;IAEFJ,MAAM,CAACK,OAAO,CAACC,SAAAA,GAAG,EAAI;QACpB,IAAIA,GAAG,EAAE;YACP,IAAMC,QAAQ,GAAGD,GAAG,CAACJ,SAAS,CAAC,AAAC;YAChC,IAAIK,QAAQ,KAAKC,SAAS,EACxB,MAAMC,KAAK,CACT,yFAAyF,CAC1F,CAAC;YACJP,SAAS,CAACC,MAAM,GAAGI,QAAQ,CAAC;QAC9B,CAAC;IACH,CAAC,CAAC,CAAC;IAEH,IAAMG,YAAY,GAAG,SAACC,IAAU,EAAK;QACnC,IAAMC,UAAU,GAAyB;YACvCR,IAAI,EAAE,KAAK;YACXO,IAAI,EAAJA,IAAI;YACJV,GAAG,EAAHA,GAAG;YACHY,MAAM,EAAE,SAACC,IAAI,EAAEC,EAAE,EAAK;gBACpB,IAAMC,IAAI,GAAGL,IAAI,CAACG,IAAI,CAAC,AAAC;gBACxB,IAAI,CAACE,IAAI,EAAE,OAAO;gBAClBL,IAAI,CAACG,IAAI,CAAC,GAAGC,EAAE,CAACC,IAAI,CAAC,CAAC;YACxB,CAAC;SACF,AAAC;QAEFhB,MAAM,CAACiB,OAAO,EAAE,CAAC,CAAC,0BAA0B;QAE5CjB,MAAM,CAACK,OAAO,CAACC,SAAAA,GAAG;mBAAIA,GAAG,IAAIA,GAAG,CAACM,UAAU,CAAC;SAAA,CAAC,CAAC;IAChD,CAAC,AAAC;IAEF,OAAO;QAACV,SAAS,CAACC,MAAM;QAAEO,YAAY;KAAC,CAAU;AACnD,CAAC"}