{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/m78/src/seed/create-use-state.ts"],"sourcesContent":["import { Seed } from \"@m78/seed\";\nimport { useState } from \"react\";\nimport { useSyncExternalStore } from \"use-sync-external-store/shim\";\nimport { useFn } from \"@m78/hooks\";\nimport { UseState } from \"./types\";\n\nexport function _createUseState(seed: Seed) {\n  const defSelector = (d: any) => d;\n\n  const _useState: UseState<any> = (selector = defSelector, equalFn) => {\n    const select = useFn(() => {\n      return selector(seed.get());\n    });\n\n    // 用作缓存前一状态的state 通过引用直接操作\n    const [deps] = useState(() => ({\n      state: select(),\n    }));\n\n    const getSnapshot = useFn(() => {\n      const selected = select();\n\n      if (equalFn && equalFn(selected, deps.state)) return deps.state;\n\n      if (selected === deps.state) return deps.state;\n\n      deps.state = selected;\n\n      return selected;\n    });\n\n    return useSyncExternalStore(seed.subscribe, getSnapshot, select);\n  };\n\n  return _useState;\n}\n"],"names":["useState","useSyncExternalStore","useFn","_createUseState","seed","defSelector","d","_useState","selector","equalFn","select","get","state","deps","getSnapshot","selected","subscribe"],"mappings":"AAAA;AACA,SAASA,QAAQ,QAAQ,OAAO,CAAC;AACjC,SAASC,oBAAoB,QAAQ,8BAA8B,CAAC;AACpE,SAASC,KAAK,QAAQ,YAAY,CAAC;AAGnC,OAAO,SAASC,eAAe,CAACC,IAAU,EAAE;IAC1C,IAAMC,WAAW,GAAG,SAACC,CAAM;eAAKA,CAAC;KAAA,AAAC;IAElC,IAAMC,SAAS,GAAkB,WAAqC;YAApCC,QAAQ,oEAAGH,WAAW,EAAEI,OAAO;QAC/D,IAAMC,MAAM,GAAGR,KAAK,CAAC,WAAM;YACzB,OAAOM,QAAQ,CAACJ,IAAI,CAACO,GAAG,EAAE,CAAC,CAAC;QAC9B,CAAC,CAAC,AAAC;QAEH,0BAA0B;QAC1B,IAAeX,GAEZ,oBAFYA,QAAQ,CAAC;mBAAO;gBAC7BY,KAAK,EAAEF,MAAM,EAAE;aAChB;SAAC,CAAC,IAAA,EAFIG,IAAI,GAAIb,GAEZ,GAFQ,AAEP;QAEJ,IAAMc,WAAW,GAAGZ,KAAK,CAAC,WAAM;YAC9B,IAAMa,QAAQ,GAAGL,MAAM,EAAE,AAAC;YAE1B,IAAID,OAAO,IAAIA,OAAO,CAACM,QAAQ,EAAEF,IAAI,CAACD,KAAK,CAAC,EAAE,OAAOC,IAAI,CAACD,KAAK,CAAC;YAEhE,IAAIG,QAAQ,KAAKF,IAAI,CAACD,KAAK,EAAE,OAAOC,IAAI,CAACD,KAAK,CAAC;YAE/CC,IAAI,CAACD,KAAK,GAAGG,QAAQ,CAAC;YAEtB,OAAOA,QAAQ,CAAC;QAClB,CAAC,CAAC,AAAC;QAEH,OAAOd,oBAAoB,CAACG,IAAI,CAACY,SAAS,EAAEF,WAAW,EAAEJ,MAAM,CAAC,CAAC;IACnE,CAAC,AAAC;IAEF,OAAOH,SAAS,CAAC;AACnB,CAAC"}