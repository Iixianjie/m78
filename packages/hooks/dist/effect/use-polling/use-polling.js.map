{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/hooks/src/effect/use-polling/use-polling.ts"],"sourcesContent":["/** 配置参数 */\nimport { useFn } from \"../use-fn/use-fn\";\nimport { useEffect, useMemo } from \"react\";\nimport { useSelf } from \"../../state/use-self/use-self\";\n\nexport interface UsePollingOption {\n  /** 轮询触发时调用, 执行结束后才会开始下一次轮询计时 */\n  trigger: () => Promise<any> | void;\n  /** 触发的间隔时间(ms) */\n  interval: number;\n  /** 触发时间会根据比例逐步变长, 例如传1.1表示, 每次间隔会相比上次延长1.1倍 */\n  growRatio?: number;\n  /** 通常配合growsRatio使用, 设置最长的触发间隔(ms) */\n  growMaxInterval?: number;\n  /** 最大的轮询次数 */\n  maxPollingNumber?: number;\n  /** 初始化或enable变更为true时是否立即触发一次 */\n  initTrigger?: boolean;\n  /** true | 是否启用 */\n  enable?: boolean;\n}\n\n/** 创建轮询任务 */\nexport function usePolling(option: UsePollingOption) {\n  const { enable = true } = option;\n\n  const self = useSelf({\n    /** 内部的计时间隔, 由growRatio等配置动态调整 */\n    internalInterval: option.interval,\n    /** 计时器标识 */\n    timer: null as any,\n    /** 轮询次数, 以每次enable为true开始计数 */\n    count: 0,\n  });\n\n  /** 放在useFn中, 保证每次调用trigger都是最新的 */\n  const cb = useFn(async () => {\n    self.count += 1;\n    try {\n      await option.trigger();\n    } catch (e) {\n      console.log(e);\n    }\n  });\n\n  useMemo(() => {\n    // 若变更则实时设置\n    self.internalInterval = option.interval;\n  }, [option.interval]);\n\n  const polling = useFn(async (init?: boolean) => {\n    if (option.maxPollingNumber && self.count >= option.maxPollingNumber) {\n      return;\n    }\n\n    if (option.initTrigger && init) {\n      await cb();\n    }\n\n    // 保留当次调用的配置快照, 防止变更\n    const { growRatio, growMaxInterval } = option;\n\n    self.timer = setTimeout(async () => {\n      try {\n        await cb();\n      } finally {\n        if (growRatio) {\n          self.internalInterval *= growRatio;\n          if (growMaxInterval) {\n            self.internalInterval = Math.min(\n              self.internalInterval,\n              growMaxInterval\n            );\n          }\n        }\n\n        polling();\n      }\n    }, self.internalInterval);\n  });\n\n  useEffect(() => {\n    if (enable) {\n      polling(true);\n    }\n\n    return () => {\n      clearTimeout(self.timer);\n    };\n  }, [enable]);\n\n  return {\n    /** 清理并重置当前的各种计数值, 然后重新开始轮询 */\n    reset: () => {\n      clearTimeout(self.timer);\n      self.count = 0;\n      self.internalInterval = option.interval;\n      polling(true);\n    },\n  };\n}\n"],"names":["useFn","useEffect","useMemo","useSelf","usePolling","option","enable","self","internalInterval","interval","timer","count","cb","e","trigger","console","log","polling","init","growRatio","growMaxInterval","maxPollingNumber","initTrigger","setTimeout","Math","min","clearTimeout","reset"],"mappings":"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"}