{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/hooks/src/state/use-select/select-manager.ts","<<jsx-config-pragma.js>>"],"sourcesContent":["import {\n  AnyObject,\n  createEvent,\n  CustomEvent,\n  isFunction,\n  isString,\n  isTruthyOrZero,\n} from \"@m78/utils\";\n\ntype SelectManagerValue = string | number;\n\nexport interface SelectManagerOption<Item = SelectManagerValue> {\n  /** 选项列表 */\n  list: Item[];\n  /**\n   * 控制如何从list的每一项中获取到value, value具有以下限制:\n   * - 作为是否选中的标识, 其必须唯一\n   * - 必须是字符串或数值\n   * */\n  valueMapper?: string | ((i: Item) => SelectManagerValue);\n}\n\nexport interface SelectManagerSelectedMeta<Item = SelectManagerValue> {\n  /** 当前选中项的值, 包含strangeSelected */\n  selected: SelectManagerValue[];\n  /** 选中项的原始选项, 包含strangeSelected */\n  originalSelected: Item[];\n  /** 不存在于option.list的选中项 */\n  strangeSelected: SelectManagerValue[];\n  /** 选中且list中包含的选项, 相当于 selected - strangeSelected */\n  realSelected: SelectManagerValue[];\n}\n\n/**\n * partialSelected / allSelected 仅检测list中存在的权限\n * selectAll / toggleAll 仅选中list中存在的选项\n * */\n\n/**\n * 用于列表的选中项管理, 内置了对于超大数据量的优化\n *\n * - 怪异选中, 如果选中了list中不存在的选项, 称为怪异选中, 可以通过 selected.strangeSelected 访问这些选项, 存在此行为时, 以下api行为需要注意:\n * partialSelected / allSelected 仅检测list中存在的权限\n * selectAll / toggleAll 仅选中list中存在的选项\n * */\nexport class SelectManager<Item = SelectManagerValue> {\n  /** 将list映射为字典, 减少循环的频率, 若i为非0 falsy值, 则存储为null, 取值时取v(减少存储占用的内存) */\n  #listMap: {\n    [key: SelectManagerValue]: { v: SelectManagerValue; i: Item | null };\n  } = {};\n\n  /** 已选值, 如果存在key则为已选, val存放选中的值(相对于key可以保留实际类型) */\n  #selectedMap: AnyObject = {};\n\n  /** 选中值变更时触发的事件 */\n  changeEvent: CustomEvent<VoidFunction>;\n\n  constructor(public readonly option: SelectManagerOption<Item>) {\n    this.changeEvent = createEvent();\n\n    this.#syncListMap();\n  }\n\n  /** 从list项中获取值(根据valueMapper) */\n  getValueByItem(i: Item) {\n    const { valueMapper } = this.option;\n\n    let v: SelectManagerValue;\n\n    if (isString(valueMapper)) {\n      v = (i as any)[valueMapper];\n    } else if (isFunction(valueMapper)) {\n      v = valueMapper(i);\n    } else {\n      v = i as SelectManagerValue;\n    }\n\n    return v;\n  }\n\n  /** 值是否在list中存在 */\n  isWithinList(val: SelectManagerValue) {\n    return !!this.#listMap[val];\n  }\n\n  /** 检测值是否被选中 */\n  isSelected(val: SelectManagerValue) {\n    return String(val) in this.#selectedMap;\n  }\n\n  /** 当前选中项的信息 */\n  get selected(): SelectManagerSelectedMeta<Item> {\n    const originalSelected: Item[] = [];\n    const realSelected: SelectManagerValue[] = [];\n    const strangeSelected: SelectManagerValue[] = [];\n\n    for (const key in this.#selectedMap) {\n      const i = this.#listMap[key];\n\n      if (i) {\n        originalSelected.push((i.i === null ? i.v : i.i) as Item);\n        realSelected.push(i.v);\n      } else {\n        const v = this.#selectedMap[key];\n        originalSelected.push(v);\n        strangeSelected.push(v);\n      }\n    }\n\n    const selected = originalSelected.map((i) => this.getValueByItem(i));\n\n    return {\n      originalSelected,\n      selected,\n      realSelected,\n      strangeSelected,\n    };\n  }\n\n  /** list中部分值被选中, 不计入strangeSelected */\n  get partialSelected(): boolean {\n    for (const key in this.#selectedMap) {\n      if (this.isWithinList(key)) return true;\n    }\n    return false;\n  }\n\n  /** 当前list中的选项是否全部选中, 不计入strangeSelected */\n  get allSelected(): boolean {\n    const meta = this.selected;\n\n    const realLength = meta.selected.length - meta.strangeSelected.length;\n\n    return realLength === this.option.list.length;\n  }\n\n  /** 重新设置option.list */\n  setList(list: Item[]) {\n    this.option.list = list;\n    this.#syncListMap();\n    this.#emitChange();\n  }\n\n  /** 选中传入的值 */\n  select(val: SelectManagerValue) {\n    this.#selectedMap[val] = val;\n    this.#emitChange();\n  }\n\n  /** 取消选中传入的值 */\n  unSelected(val: SelectManagerValue) {\n    delete this.#selectedMap[val];\n    this.#emitChange();\n  }\n\n  /** 选择全部值 */\n  selectAll() {\n    for (const key in this.#listMap) {\n      this.#selectedMap[key] = this.#listMap[key].v;\n    }\n    this.#emitChange();\n  }\n\n  /** 取消选中所有值 */\n  unSelectAll() {\n    this.#selectedMap = {};\n    this.#emitChange();\n  }\n\n  /** 反选值 */\n  toggle(val: SelectManagerValue) {\n    const unlock = this.#lock();\n    if (this.isSelected(val)) {\n      this.unSelected(val);\n    } else {\n      this.select(val);\n    }\n    unlock();\n    this.#emitChange();\n  }\n\n  /** 反选所有值 */\n  toggleAll() {\n    const unlock = this.#lock();\n    for (const key in this.#listMap) {\n      this.toggle(key);\n    }\n    unlock();\n    this.#emitChange();\n  }\n\n  /** 一次性设置所有选中的值 */\n  setAllSelected(next: SelectManagerValue[]) {\n    this.#selectedMap = {};\n    next.forEach((val) => (this.#selectedMap[val] = val));\n    this.#emitChange();\n  }\n\n  /** 设置指定值的选中状态 */\n  setSelected(val: SelectManagerValue, isSelect: boolean) {\n    const unlock = this.#lock();\n    if (isSelect) {\n      this.select(val);\n    } else {\n      this.unSelected(val);\n    }\n    unlock();\n    this.#emitChange();\n  }\n\n  /** 一次选中多个选项 */\n  selectList(selectList: SelectManagerValue[]) {\n    selectList.forEach((val) => (this.#selectedMap[val] = val));\n    this.#emitChange();\n  }\n\n  /** 以列表的形式移除选中项 */\n  unSelectList(selectList: SelectManagerValue[]) {\n    selectList.forEach((key) => delete this.#selectedMap[key]);\n    this.#emitChange();\n  }\n\n  /** 根据当前的option.list同步listMap */\n  #syncListMap() {\n    this.#listMap = {};\n\n    this.option.list.forEach((i: Item) => {\n      const v = this.getValueByItem(i);\n\n      const type = typeof v;\n\n      if (v === undefined || (type !== \"string\" && type !== \"number\")) return;\n\n      this.#listMap[v] = {\n        v,\n        i: isTruthyOrZero(i) ? i : null,\n      };\n    });\n  }\n\n  #lockFlag = 1;\n\n  /** 锁定change触发器, 锁定期间其他触发器调用不会触发 */\n  #lock() {\n    if (this.#lockFlag === 1) {\n      this.#lockFlag = 0;\n      return () => (this.#lockFlag = 1);\n    }\n\n    return () => {};\n  }\n\n  /** 触发变更实际, 搭配changeLock使用 */\n  #emitChange() {\n    if (!this.#lockFlag) return;\n    this.changeEvent.emit();\n  }\n}\n","React.createElement"],"names":["createEvent","isFunction","isString","isTruthyOrZero","SelectManager","option","listMap","selectedMap","lockFlag","changeEvent","syncListMap","getValueByItem","i","valueMapper","v","isWithinList","val","isSelected","String","setList","list","emitChange","select","unSelected","selectAll","key","unSelectAll","toggle","unlock","lock","toggleAll","setAllSelected","next","forEach","setSelected","isSelect","selectList","unSelectList","selected","originalSelected","realSelected","strangeSelected","push","map","partialSelected","allSelected","meta","realLength","length","type","undefined","emit"],"mappings":"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"}