{"version":3,"sources":["/Users/lixianjie/project/openSource/m78/packages/hooks/src/state/use-storage-state/use-storage-state.ts"],"sourcesContent":["import { StateInitState, SetStateBase, useFn } from \"../../\";\nimport { __GLOBAL__ } from \"@m78/utils\";\nimport { useState } from \"react\";\n\n/** 配置 */\nexport interface UseStorageStateOptions {\n  /** 缓存类型 */\n  type?: \"local\" | \"session\";\n  /** false | 是否禁用缓存 */\n  disabled?: boolean;\n  /** 缓存有效时间(ms) */\n  validTime?: number;\n}\n\n/** 缓存key前缀 */\nconst BASE_KEY = \"USE_STORAGE_CACHE\";\n\nconst getCacheKey = (key: string) => `${BASE_KEY}_${key.toUpperCase()}`;\nconst getCacheTimeKey = (key: string) => `${BASE_KEY}_${key.toUpperCase()}_AT`;\n\n/** 用于缓存的环境api */\nconst storageMethod = {\n  local: (__GLOBAL__ as Window).localStorage,\n  session: (__GLOBAL__ as Window).sessionStorage,\n};\n\nfunction setStorage(\n  key: string,\n  val: any,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  if (val === undefined) return;\n  const method = storageMethod[type!];\n  if (!method) return;\n  method.setItem(getCacheKey(key), JSON.stringify(val));\n  method.setItem(getCacheTimeKey(key), String(Date.now()));\n}\n\nfunction getStorage(\n  key: string,\n  type = \"session\" as UseStorageStateOptions[\"type\"],\n  validTime = 0\n) {\n  const method = storageMethod[type!];\n  if (!method) return null;\n  const cache = method.getItem(getCacheKey(key));\n\n  if (cache === null) return null;\n\n  const cacheTime = Number(method.getItem(getCacheTimeKey(key)));\n\n  const data = JSON.parse(cache);\n\n  if (!validTime || Number.isNaN(cacheTime) || !cacheTime) return data;\n\n  const diff = Date.now() - (validTime + cacheTime);\n\n  if (diff > 0) {\n    remove(key, type);\n    return null;\n  }\n\n  return data;\n}\n\nfunction remove(\n  key: string,\n  type = \"session\" as UseStorageStateOptions[\"type\"]\n) {\n  const method = storageMethod[type!];\n  if (!method) return;\n  method.removeItem(getCacheKey(key));\n  method.removeItem(getCacheTimeKey(key));\n}\n\nconst defaultOptions: Required<UseStorageStateOptions> = {\n  type: \"session\",\n  disabled: false,\n  validTime: 0,\n};\n\n/**\n * 基础缓存逻辑实现\n * */\nfunction useStorageBase<T = undefined>(\n  key: string,\n  initState?: StateInitState<T>,\n  options?: UseStorageStateOptions\n): [T, SetStateBase<T>] {\n  const opt = {\n    ...defaultOptions,\n    ...options,\n  };\n\n  const [state, setState] = useState<T>(() => {\n    if (!opt.disabled) {\n      const cache = getStorage(key, opt.type, options?.validTime);\n      if (cache !== null) {\n        // null以外的值都视为缓存\n        return cache;\n      }\n    }\n\n    if (initState instanceof Function) {\n      const _initState = initState();\n      !opt.disabled && setStorage(key, _initState, opt.type);\n      return _initState;\n    }\n    !opt.disabled && setStorage(key, initState, opt.type);\n    return initState;\n  });\n\n  const memoSetState: SetStateBase<T> = useFn((patch) => {\n    if (patch instanceof Function) {\n      setState((prev) => {\n        const patchRes = patch(prev);\n        !opt.disabled && setStorage(key, patchRes, opt.type);\n        return patchRes;\n      });\n    } else {\n      !opt.disabled && setStorage(key, patch, opt.type);\n      setState(patch);\n    }\n  });\n\n  return [state, memoSetState];\n}\n\n/**\n * useState的storage版本\n * */\nexport const useStorageState = Object.assign(useStorageBase, {\n  get: getStorage,\n  set: setStorage,\n  remove,\n});\n"],"names":["useFn","__GLOBAL__","useState","BASE_KEY","getCacheKey","key","toUpperCase","getCacheTimeKey","storageMethod","local","localStorage","session","sessionStorage","setStorage","val","type","undefined","method","setItem","JSON","stringify","String","Date","now","getStorage","validTime","cache","getItem","cacheTime","Number","data","parse","isNaN","diff","remove","removeItem","defaultOptions","disabled","useStorageBase","initState","options","opt","Function","_initState","state","setState","memoSetState","patch","prev","patchRes","useStorageState","Object","assign","get","set"],"mappings":"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"}